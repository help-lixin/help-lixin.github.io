I"<h3 id="1nioserversocketchannel-类结构图">(1).NioServerSocketChannel 类结构图</h3>
<p><img src="/assets/netty/imgs/NioServerSocketChannel.png" alt="&quot;NioServerSocketChannel类结构图&quot;" /></p>

<h3 id="2nioserversocketchannel初始化过程">(2).NioServerSocketChannel初始化过程</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private static final SelectorProvider DEFAULT_SELECTOR_PROVIDER = SelectorProvider.provider();


// 1.通过反射工厂创建该对象
public NioServerSocketChannel() {
    // 1.1 newSocket
    // 1.2 this
    this(newSocket(DEFAULT_SELECTOR_PROVIDER));
}


// 1.2 构造器
public NioServerSocketChannel(ServerSocketChannel channel) {
    // channel = sun.nio.ch.ServerSocketChannelImpl
    // 3.调用父类(AbstractNioMessageChannel/AbstractNioChannel/AbstractChannel)的构造器
    super(null, channel, SelectionKey.OP_ACCEPT);
    config = new NioServerSocketChannelConfig(this, javaChannel().socket());
}

// 1.1 创建:ServerSocketChannel
private static ServerSocketChannel newSocket(SelectorProvider provider) {
    try {
         return provider.openServerSocketChannel();
    } catch (IOException e) {
        throw new ChannelException("Failed to open a server socket.", e);
    }
} //end newSocket
</code></pre></div></div>

<h3 id="3abstractniomessagechannel">(3).AbstractNioMessageChannel</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected AbstractNioMessageChannel(Channel parent, SelectableChannel ch, int readInterestOp) {
    // parent = null
    // ch = sun.nio.ch.ServerSocketChannelImpl
    // readInterestOp = SelectionKey.OP_ACCEPT(16)
    
    // 4. 调用父类(AbstractNioChannel)的构造器
    super(parent, ch, readInterestOp);
}
</code></pre></div></div>

<h3 id="4abstractniochannel">(4).AbstractNioChannel</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected AbstractNioChannel(Channel parent, SelectableChannel ch, int readInterestOp) {
    // parent = null
    // ch = sun.nio.ch.ServerSocketChannelImpl
    // readInterestOp = SelectionKey.OP_ACCEPT(16)
    
    // 5.调用父类(AbstractChannel)构造器
    super(parent);
    
    this.ch = ch;
   this.readInterestOp = readInterestOp;
    
    try {
        // 设置非阻塞
        ch.configureBlocking(false);
    } catch (IOException e) {
        try {
            // 有异常的情况下关闭
            ch.close();
        } catch (IOException e2) {
            logger.warn("Failed to close a partially initialized socket.", e2);
        }
        throw new ChannelException("Failed to enter non-blocking mode.", e);
    } // end catch
}
</code></pre></div></div>

<h3 id="5abstractchannel">(5).AbstractChannel</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected AbstractChannel(Channel parent) {
    // parent = null
    this.parent = parent;
    // 创建ChannelId
    id = newId();
    
    // 6.调用AbstractNioMessageChannel.newUnsafe() 创建Channel$Unsafe
    unsafe = newUnsafe();
    
    // 创建DefaultChannelPipeline
    pipeline = newChannelPipeline();
}

// 创建默认的ChannelPipeline
protected DefaultChannelPipeline newChannelPipeline() {
    return new DefaultChannelPipeline(this);
}

</code></pre></div></div>

<h3 id="6abstractniomessagechannelnewunsafe">(6).AbstractNioMessageChannel.newUnsafe</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// AbstractNioMessageChannel
protected AbstractNioUnsafe newUnsafe() {
    return new NioMessageUnsafe();
}
</code></pre></div></div>

<h3 id="7nioserversocketchannel-初始化过程图解">(7).NioServerSocketChannel 初始化过程图解</h3>
<p><img src="/assets/netty/imgs/NioServerSocketChannel-Invoker.png" alt="&quot;NioServerSocketChannel调用过程&quot;" /></p>

<h3 id="8nioserversocketchannel-初始化总结">(8).NioServerSocketChannel 初始化总结</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. 创建:ServerSocketChannel(sun.nio.ch.ServerSocketChannelImpl)
2. 创建:Unsafe对象(NioMessageUnsafe)
3. 创建:DefaultChannelPipeline对象
</code></pre></div></div>
:ET